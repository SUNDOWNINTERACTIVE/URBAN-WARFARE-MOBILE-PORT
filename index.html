<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>URBAN WARFARE: TACTICAL ASSAULT</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Press+Start+2P&display=swap');
        
        body {
            margin: 0;
            background-color: #050505;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            color: white;
            font-family: 'Press Start 2P', cursive;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none; /* Prevents zooming on mobile */
        }

        #game-wrapper {
            position: relative;
            width: 800px;
            max-width: 100%; /* Responsive Width */
            aspect-ratio: 16/9; /* Maintain Aspect Ratio */
            box-shadow: 0 0 100px rgba(100,0,0,0.6);
            border: 8px solid #1a1a1a;
            background-color: #000;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
            image-rendering: pixelated; 
        }

        #scanlines {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%);
            background-size: 100% 4px; pointer-events: none; z-index: 10;
        }

        #ui-layer {
            position: absolute; top: 15px; left: 20px; width: calc(100% - 40px); pointer-events: none;
            display: none; justify-content: space-between; align-items: flex-start;
            font-size: 12px; z-index: 20; color: #fff; text-shadow: 2px 2px #000;
        }

        /* Responsive text adjustment */
        @media (max-width: 600px) {
            #ui-layer { font-size: 8px; top: 5px; left: 10px; width: calc(100% - 20px); }
        }

        #hp-bar { display: flex; gap: 5px; margin-bottom: 5px; }
        .heart {
            width: 16px; height: 16px; background: #e74c3c;
            display: inline-block; clip-path: polygon(0% 0%, 100% 0%, 100% 100%, 0% 100%);
            border: 2px solid #fff; box-shadow: 2px 2px 0 #000;
        }

        #controls-bar {
            pointer-events: auto;
            display: flex; gap: 10px;
        }
        .hud-btn {
            background: #222; border: 2px solid #555; color: #aaa;
            padding: 5px 10px; font-family: 'Press Start 2P'; font-size: 10px;
            cursor: pointer; text-transform: uppercase;
        }
        .hud-btn:hover { background: #444; color: #fff; border-color: #fff; }

        /* SPLASH & TITLE */
        #splash-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 200;
            animation: fadeOutSplash 4s forwards;
        }
        #splash-text {
            color: #fff; font-family: 'Black Ops One', cursive; font-size: 30px; letter-spacing: 5px;
            opacity: 0; animation: fadeInOutText 3s ease-in-out;
            text-align: center;
        }

        #title-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, #222 0%, #000 90%);
            display: none; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 100; text-align: center;
            opacity: 0; transition: opacity 2s ease-in;
        }

        h1 { 
            font-family: 'Black Ops One', cursive; color: #e74c3c; font-size: 70px; margin: 0;
            text-shadow: 0px 4px 0px #000, 0 0 20px rgba(255,0,0,0.4);
            letter-spacing: 2px; animation: pulse 3s infinite;
        }
        @media (max-width: 600px) { h1 { font-size: 40px; } }

        h2 { 
            color: #fff; font-size: 24px; margin: 10px 0 40px 0; 
            text-transform: uppercase; letter-spacing: 4px; font-weight: bold;
            border-top: 3px solid #e74c3c; border-bottom: 3px solid #e74c3c; padding: 10px 30px;
        }
        @media (max-width: 600px) { h2 { font-size: 14px; padding: 5px 10px; } }
        
        .start-msg { margin-top: 20px; font-size: 16px; color: #fff; animation: blink 1s infinite; cursor: pointer; }
        .controls { font-size: 12px; color: #888; line-height: 24px; margin-top: 30px; }

        /* --- MOBILE CONTROLS --- */
        #mobile-controls {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; /* Let touches pass through empty areas */
            z-index: 300; display: none;
        }
        
        /* Only show on touch devices or small screens */
        @media (hover: none) and (pointer: coarse), (max-width: 800px) {
            #mobile-controls { display: block; }
            .controls { display: none; } /* Hide PC instructions */
            .start-msg::after { content: " / TAP SCREEN"; }
        }

        .touch-zone {
            position: absolute; bottom: 20px;
            pointer-events: auto;
            display: flex; gap: 15px;
        }
        .left-zone { left: 20px; align-items: flex-end; }
        .right-zone { right: 20px; align-items: flex-end; gap: 20px; }

        .t-btn {
            width: 60px; height: 60px;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            color: rgba(255,255,255,0.7);
            display: flex; justify-content: center; align-items: center;
            font-size: 20px; user-select: none;
            backdrop-filter: blur(2px);
        }
        .t-btn:active { background: rgba(255,255,255,0.4); color: #fff; transform: scale(0.95); }
        .sq { border-radius: 10px; width: 50px; height: 50px; font-size: 12px; }
        .grenade-btn { border-color: #2ecc71; color: #2ecc71; }
        .shoot-btn { border-color: #e74c3c; width: 70px; height: 70px; background: rgba(231, 76, 60, 0.2); }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
        @keyframes blink { 50% { opacity: 0; } }
        @keyframes fadeInOutText { 0% { opacity: 0; transform: scale(0.9); } 20% { opacity: 1; transform: scale(1); } 80% { opacity: 1; transform: scale(1); } 100% { opacity: 0; transform: scale(1.1); } }
        @keyframes fadeOutSplash { 0% { opacity: 1; pointer-events: all; } 90% { opacity: 1; pointer-events: all; } 100% { opacity: 0; pointer-events: none; } }
    </style>
</head>
<body>

<div id="game-wrapper">
    <canvas id="gameCanvas" width="800" height="450"></canvas>
    <div id="scanlines"></div>
    
    <div id="mobile-controls">
        <div class="touch-zone left-zone">
            <div class="t-btn" id="btn-left">◄</div>
            <div class="t-btn" id="btn-right">►</div>
        </div>
        <div class="touch-zone right-zone">
            <div class="t-btn sq grenade-btn" id="btn-grenade">G</div>
            <div class="t-btn shoot-btn" id="btn-shoot">FIRE</div>
            <div class="t-btn" id="btn-jump">▲</div>
        </div>
    </div>
    
    <div id="ui-layer">
        <div style="text-align:left;">
            <div id="hp-bar"></div>
            <div id="livesDisplay" style="color:#aaa;">LIVES: 3</div>
            <div id="grenadeDisplay" style="color:#2ecc71; margin-top:5px;">GRENADES: 3</div>
        </div>
        <div style="text-align:right;">
            <div id="controls-bar">
                <button class="hud-btn" id="musicBtn" onclick="toggleMusic()">MUSIC: ON</button>
                <button class="hud-btn" onclick="toggleFullscreen()">SCREEN</button>
            </div>
            <div style="margin-top:10px;">
                <span id="scoreDisplay">SCORE: 000000</span><br>
                <span id="stageDisplay" style="color:#f1c40f;">OP 1</span><br>
                <span id="biomeDisplay" style="color:#aaa; font-size:10px;">JUNGLE</span>
            </div>
        </div>
    </div>

    <div id="splash-screen">
        <div id="splash-text">SUNDOWN INTERACTIVE<br><span style="font-size:14px; letter-spacing:2px; color:#e74c3c;">2026 PRESENTATION</span></div>
    </div>

    <div id="title-screen">
        <h1>URBAN WARFARE</h1>
        <h2>TACTICAL ASSAULT</h2>
        <div class="start-msg" id="start-btn">PRESS [ENTER] TO DEPLOY</div>
        <div class="controls">ARROWS: MOVE <br> Z: JUMP &nbsp;|&nbsp; X: SHOOT &nbsp;|&nbsp; C: GRENADE</div>
        <div style="position:absolute; bottom:15px; font-size:10px; color:#444;">SUNDOWN INTERACTIVE 2026</div>
    </div>
</div>

<script>
window.onload = function() {
    const splash = document.getElementById('splash-screen');
    const title = document.getElementById('title-screen');
    setTimeout(() => { title.style.display = 'flex'; void title.offsetWidth; title.style.opacity = '1'; }, 3500);

    /* --- AUDIO --- */
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    let actx, noiseBuffer, musicInterval = null, musicEnabled = true, currentNote = 0;
    const MUSIC_TRACKS = { 0: [110, 110, 0, 123, 110, 0, 130, 0], 1: [82, 0, 82, 82, 98, 0, 82, 123], 2: [55, 0, 0, 0, 65, 0, 0, 0], boss: [110, 123, 130, 146, 110, 123, 130, 164] };

    function initAudio() { 
        try { if (!actx) { actx = new AudioContext(); const b = actx.sampleRate; noiseBuffer = actx.createBuffer(1, b, actx.sampleRate); const o = noiseBuffer.getChannelData(0); for (let i = 0; i < b; i++) o[i] = Math.random() * 2 - 1; } if (actx.state === 'suspended') actx.resume(); } catch(e){}
    }
    function startMusic(biomeIdx) {
        if(musicInterval) clearInterval(musicInterval); if(!musicEnabled) return;
        let speed = 150; if(biomeIdx === 'boss') speed = 100;
        currentNote = 0; let trackKey = (biomeIdx === 'boss') ? 'boss' : biomeIdx;
        const track = MUSIC_TRACKS[trackKey] || MUSIC_TRACKS[0];
        musicInterval = setInterval(() => {
            if(!isGameRunning) { clearInterval(musicInterval); return; }
            let freq = track[currentNote % track.length];
            if(freq > 0) playSynthTone(freq, 'sawtooth', 0.1, 0.1);
            if(currentNote % 4 === 0) playNoise(0.05, 'lowpass', 100, 0.2); 
            currentNote++;
        }, speed);
    }
    function playSynthTone(f,t,d,v) { if(!actx||!musicEnabled)return; try{const o=actx.createOscillator();const g=actx.createGain();o.type=t;o.frequency.setValueAtTime(f,actx.currentTime);g.gain.setValueAtTime(v,actx.currentTime);g.gain.exponentialRampToValueAtTime(0.001,actx.currentTime+d);o.connect(g);g.connect(actx.destination);o.start();o.stop(actx.currentTime+d);}catch(e){} }
    function playNoise(d,t,f,v) { if(!actx)return; try{const s=actx.createBufferSource();s.buffer=noiseBuffer;const fl=actx.createBiquadFilter();fl.type=t;fl.frequency.setValueAtTime(f,actx.currentTime);const g=actx.createGain();g.gain.setValueAtTime(v,actx.currentTime);g.gain.exponentialRampToValueAtTime(0.01,actx.currentTime+d);s.connect(fl);fl.connect(g);g.connect(actx.destination);s.start();s.stop(actx.currentTime+d);}catch(e){} }
    window.toggleMusic = function() { musicEnabled=!musicEnabled; document.getElementById('musicBtn').innerText="MUSIC: "+(musicEnabled?"ON":"OFF"); if(!musicEnabled)clearInterval(musicInterval); else { let b=getBiomeIndex(level); if(level%3===0)b='boss'; startMusic(b); } }
    window.toggleFullscreen = function() { let el=document.getElementById('game-wrapper'); if(!document.fullscreenElement)el.requestFullscreen(); else if(document.exitFullscreen)document.exitFullscreen(); }

    /* --- GAME ENGINE --- */
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    ctx.imageSmoothingEnabled = false;
    const GW=800; const GH=450;
    let isGameRunning=false; let level=1; let score=0; let lives=3; let frameCount=0; let cameraX=0; let shake=0;
    
    // MODIFIED CONTROLS FOR MOBILE
    const keys={ArrowLeft:false,ArrowRight:false,ArrowUp:false,ArrowDown:false,z:false,x:false,c:false};
    let cPressed=false;

    // Keyboard Listeners
    window.addEventListener('keydown', e => { if(keys.hasOwnProperty(e.key)) keys[e.key]=true; if(e.key==="Enter"&&!isGameRunning&&title.style.display==='flex') startGame(); });
    window.addEventListener('keyup', e => { if(keys.hasOwnProperty(e.key)) keys[e.key]=false; if(e.key==='c') cPressed=false; });

    // Touch Listeners Logic
    function bindTouch(id, key) {
        const el = document.getElementById(id);
        el.addEventListener('touchstart', (e) => { e.preventDefault(); keys[key] = true; });
        el.addEventListener('touchend', (e) => { e.preventDefault(); keys[key] = false; if(key==='c') cPressed=false; });
    }
    bindTouch('btn-left', 'ArrowLeft');
    bindTouch('btn-right', 'ArrowRight');
    bindTouch('btn-jump', 'z');
    bindTouch('btn-shoot', 'x');
    bindTouch('btn-grenade', 'c');
    
    // Tap to Start
    document.getElementById('start-btn').addEventListener('touchstart', (e) => {
        e.preventDefault();
        if(!isGameRunning && title.style.display==='flex') startGame();
    });

    let player=null; 
    let platforms=[], enemies=[], bullets=[], particles=[], powerups=[], hazards=[], boss=null, goal=null;
    let bgElements=[], bgParticles=[], debris=[], bloodPools=[];

    const BIOMES = [
        { name: "JUNGLE", skyTop:'#87CEEB', skyBot:'#228B22', plat:'#3d5c25', detail:'#1e3315' },
        { name: "RUINED CITY", skyTop:'#2c3e50', skyBot:'#e74c3c', plat:'#222', detail:'#444' },
        { name: "TECH BASE", skyTop:'#000000', skyBot:'#000033', plat:'#555', detail:'#7f8c8d' }
    ];
    function getBiomeIndex(lvl) { if(lvl<=3)return 0; if(lvl<=6)return 1; return 2; }

    /* --- LOGIC --- */
    class Player {
        constructor() { this.x=100; this.y=300; this.w=24; this.h=55; this.vx=0; this.vy=0; this.grounded=false; this.faceR=true; this.weapon='normal'; this.shootT=0; this.invul=0; this.state='idle'; this.hp=3; this.grenades=3; }
        update() {
            if(keys.ArrowRight){this.vx=3; this.faceR=true; this.state='run';} else if(keys.ArrowLeft){this.vx=-3; this.faceR=false; this.state='run';} else{this.vx*=0.8; this.state='idle';}
            if(keys.z && this.grounded){this.vy=-11; this.grounded=false; playNoise(0.15,'triangle',100,0.1);}
            if(!this.grounded) this.state='jump';
            if(this.shootT>0) this.shootT--; if(keys.x && this.shootT===0) this.shoot();
            if(keys.c && !cPressed && this.grenades>0) { cPressed=true; this.throwGrenade(); }
            this.vy+=0.5; this.x+=this.vx; this.y+=this.vy;
            this.grounded=false;
            platforms.forEach(p=>{ if(this.x<p.x+p.w && this.x+this.w>p.x && this.y+this.h>p.y && this.y+this.h<p.y+p.h+20 && this.vy>=0){ this.y=p.y-this.h; this.vy=0; this.grounded=true; } });
            if(this.y>GH+100) takeDamage(3);
            if(this.x<cameraX+10) this.x=cameraX+10;
            let tCam = this.x-GW*0.35; if(tCam>cameraX) cameraX+=(tCam-cameraX)*0.1;
            if(this.invul>0) this.invul--;
        }
        shoot() {
            this.shootT = this.weapon==='rapid'?5:(this.weapon==='rocket'?50:15);
            let speed = this.faceR?12:-12; let type = this.weapon==='rocket'?'rocket':'normal';
            if(type==='rocket') { speed=this.faceR?3:-3; playNoise(0.5,'lowpass',100,0.4); } else { playNoise(0.1,'highpass',800,0.2); }
            bullets.push({x:this.x+(this.faceR?40:-15), y:this.y+22, vx:speed, vy:0, player:true, active:true, type:type});
            if(this.weapon==='spread'){ bullets.push({x:this.x,y:this.y+22,vx:speed,vy:-2,player:true,active:true,type:'normal'}); bullets.push({x:this.x,y:this.y+22,vx:speed,vy:2,player:true,active:true,type:'normal'}); }
            particles.push({x:this.x+(this.faceR?40:-15), y:this.y+22, vx:0, vy:0, life:5, type:'flash'});
        }
        throwGrenade() { this.grenades--; bullets.push({x:this.x, y:this.y, vx:this.faceR?6:-6, vy:-8, player:true, active:true, type:'grenade'}); playNoise(0.1,'lowpass',400,0.2); }
    }

    function initBackground(lvl) {
        bgElements=[]; bgParticles=[]; bloodPools=[]; debris=[];
        const bIndex = getBiomeIndex(lvl);
        for(let i=0; i<40; i++) bgElements.push({x:Math.random()*GW*6, y:Math.random()*GH, size:20+Math.random()*80, type:bIndex, layer:Math.floor(Math.random()*3)});
    }

    function generateLevel(lvl) {
        initBackground(lvl);
        platforms=[]; enemies=[]; powerups=[]; bullets=[]; particles=[]; hazards=[]; boss=null; goal=null;
        
        // UNIQUE LEVEL GENERATION PER BIOME
        if(lvl % 3 === 0) {
            // BOSS ARENA (FLAT + PLATFORMS)
            platforms.push({x:0, y:380, w:1200, h:70}); // Floor
            platforms.push({x:200, y:280, w:100, h:20}); // Step 1
            platforms.push({x:500, y:200, w:100, h:20}); // Step 2 (High)
            platforms.push({x:800, y:280, w:100, h:20}); // Step 3
            boss={x:600, y:200, hp:50+(lvl*15), maxHp:50+(lvl*15), active:true, startX:600, timer:0};
        } else {
            let cy=380, cx=0, len=2500+(lvl*400);
            platforms.push({x:cx,y:cy,w:800,h:70}); cx+=800;
            const bIndex = getBiomeIndex(lvl);

            while(cx < len) {
                let gap, w, h;
                // Jungle: Hills
                if(bIndex===0) { gap=50+Math.random()*50; w=200+Math.random()*200; h=Math.min(Math.max(cy+(Math.random()*80)-40, 250), 380); }
                // City: Flat
                else if(bIndex===1) { gap=0; w=400+Math.random()*400; h=380; if(Math.random()>0.7) gap=100; }
                // Base: Steps
                else { gap=50; w=150; h=Math.min(Math.max(cy+(Math.random()*100)-50, 200), 380); }
                
                cy=h;
                platforms.push({x:cx+gap, y:h, w:w, h:70});
                
                if(Math.random()>0.6) hazards.push({x:cx+gap+Math.random()*w, y:h, type:'mine', active:true});
                let eCount = 1+Math.floor(Math.random()*2);
                for(let e=0; e<eCount; e++) enemies.push({x:cx+gap+50+Math.random()*(w-100), y:h-60, hp:3, shootT:0, reactT:40, active:true, vx:1, minX:cx+gap, maxX:cx+gap+w, facingRight:true});
                if(Math.random()>0.85) powerups.push({x:cx+gap+w/2, y:h-30, type:(Math.random()<0.3?'G':(Math.random()<0.6?'L':'S')), active:true});
                cx+=gap+w;
            }
            platforms.push({x:cx+100,y:380,w:400,h:70}); goal={x:cx+250,y:300}; 
        }
    }

    // --- GORE ---
    function spawnExplosion(x,y,r) { shake=15; playNoise(0.5,'lowpass',100,0.6); for(let i=0;i<30;i++)particles.push({x:x,y:y,vx:(Math.random()-.5)*10,vy:(Math.random()-.5)*10,life:30,type:'fire',size:Math.random()*20}); enemies.forEach(e=>{if(e.active&&Math.hypot(e.x-x,e.y-y)<r){e.hp-=5;if(e.hp<=0)killEnemy(e);}}); if(boss&&boss.active&&Math.hypot(boss.x-x,boss.y-y)<r)boss.hp-=5; if(Math.hypot(player.x-x,player.y-y)<r)takeDamage(1); }
    function spawnBlood(x,y,c) { for(let i=0;i<c;i++)particles.push({x:x,y:y,vx:(Math.random()-.5)*12,vy:(Math.random()-.5)*12,life:60,type:'blood',size:3}); }
    function spawnLimb(x,y,t) { debris.push({x:x,y:y,vx:(Math.random()-.5)*10,vy:-5-Math.random()*5,w:(t==='torso'?15:8),h:8,type:'limb',part:t,angle:Math.random()*6,vAngle:(Math.random()-.5)*0.5,grounded:false}); }
    function killEnemy(e) { e.active=false; score+=100; playNoise(0.1,'lowpass',100,0.5); spawnBlood(e.x,e.y,40); spawnLimb(e.x,e.y,'head'); spawnLimb(e.x,e.y,'torso'); spawnLimb(e.x,e.y,'arm'); spawnLimb(e.x,e.y,'leg'); bloodPools.push({x:e.x,y:e.y+60,size:20+Math.random()*20}); }

    function takeDamage(amt) { if(player.invul>0)return; player.hp-=amt; player.invul=100; shake=20; playNoise(0.1,'lowpass',100,0.5); spawnBlood(player.x,player.y,10); if(player.hp<=0) die(); }
    function die() { lives--; spawnExplosion(player.x,player.y,50); spawnBlood(player.x,player.y,50); if(lives<=0) resetGame(); else { player.x=cameraX+100; player.y=100; player.vy=0; player.invul=150; player.hp=3; } }

    function update() {
        if(!isGameRunning || !player) return; if(shake>0) shake--;
        const bIndex = getBiomeIndex(level);
        if((bIndex===0||bIndex===2)&&frameCount%5===0) bgParticles.push({x:Math.random()*GW+cameraX,y:GH,vx:0,vy:-2,life:100,size:5+Math.random()*10,color:'#ffaa00'});
        bgParticles.forEach(p=>{p.y+=p.vy;p.life--;}); bgParticles=bgParticles.filter(p=>p.life>0);
        player.update();
        document.getElementById('livesDisplay').innerText="LIVES: "+lives; document.getElementById('grenadeDisplay').innerText="GRENADES: "+player.grenades;
        let hpHTML=''; for(let i=0;i<3;i++)hpHTML+=`<div class="heart" style="background:${i<player.hp?'#e74c3c':'#444'}"></div>`; document.getElementById('hp-bar').innerHTML=hpHTML;

        hazards.forEach(h=>{ if(h.active && Math.abs(player.x-h.x)<15 && Math.abs((player.y+player.h)-h.y)<10){ h.active=false; spawnExplosion(h.x,h.y,60); } });

        enemies.forEach(e=>{
            if(!e.active) return;
            e.x+=e.vx; if(e.x<e.minX||e.x>e.maxX)e.vx*=-1; e.facingRight=e.vx>0;
            if(Math.abs(player.x-e.x)<GW/2+50){
                if(e.reactT>0)e.reactT--; else{ e.shootT--; if(e.shootT<=0){ playNoise(0.1,'bandpass',600,0.1); bullets.push({x:e.x,y:e.y+25,vx:player.x>e.x?6:-6,vy:0,player:false,active:true,type:'normal'}); e.shootT=80+Math.random()*60; } }
            }
        });

        if(boss&&boss.active){
            if(player.x>boss.startX-600)cameraX=boss.startX-600+400-GW/2;
            boss.timer++; boss.y=200+Math.sin(boss.timer*0.04)*50; // Arena height
            boss.x=boss.startX+Math.cos(boss.timer*0.03)*100;
            if(boss.timer%60===0){ let a=Math.atan2(player.y-boss.y,player.x-boss.x); bullets.push({x:boss.x,y:boss.y,vx:Math.cos(a)*7,vy:Math.sin(a)*7,player:false,active:true,type:'normal'}); playNoise(0.1,'bandpass',500,0.2); }
            if(boss.hp<=0){ spawnExplosion(boss.x,boss.y,200); boss.active=false; score+=5000; setTimeout(nextLevel,3000); }
        }
        
        if(goal&&player.x>goal.x-50&&player.x<goal.x+50) nextLevel();

        bullets.forEach(b=>{
            if(!b.active) return;
            if(b.type==='rocket'){ b.vx*=1.05; particles.push({x:b.x,y:b.y,vx:0,vy:0,life:10,type:'smoke',size:5}); }
            if(b.type==='grenade'){ b.vy+=0.5; }
            b.x+=b.vx; b.y+=b.vy;
            if(b.type==='grenade'&&b.y>400){ b.active=false; spawnExplosion(b.x,b.y,80); }
            if(Math.abs(b.x-cameraX)>GW)b.active=false;
            if(b.player){
                enemies.forEach(e=>{ if(e.active&&Math.abs(b.x-e.x)<20&&Math.abs(b.y-e.y)<30){ if(b.type==='rocket'||b.type==='grenade'){b.active=false;spawnExplosion(b.x,b.y,80);} else{e.hp--;b.active=false;spawnBlood(e.x,e.y,5);if(e.hp<=0)killEnemy(e);} } });
                if(boss&&boss.active&&Math.abs(b.x-boss.x)<50&&Math.abs(b.y-boss.y)<50){ if(b.type==='rocket'||b.type==='grenade'){b.active=false;spawnExplosion(b.x,b.y,80);} else{boss.hp--;b.active=false;} }
            } else {
                if(Math.abs(b.x-player.x)<15&&Math.abs(b.y-player.y)<27){ b.active=false; takeDamage(1); }
            }
        }); bullets=bullets.filter(b=>b.active);

        powerups.forEach(p=>{ if(p.active&&Math.abs(player.x-p.x)<30&&Math.abs(player.y-p.y)<30){ p.active=false; score+=500; playSynthTone(600,'sine',0.2,0.2); if(p.type==='G')player.grenades+=3; else if(p.type==='L')player.weapon='rocket'; else player.weapon='spread'; } });

        particles.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; p.life--; if(p.type==='blood'){p.vy+=0.5;if(p.y>450)p.vy=0;} }); particles=particles.filter(p=>p.life>0);
        debris.forEach(d=>{ if(!d.grounded){ d.vy+=0.5;d.x+=d.vx;d.y+=d.vy;d.angle+=d.vAngle; platforms.forEach(p=>{if(d.x>p.x&&d.x<p.x+p.w&&d.y>p.y&&d.y<p.y+20&&d.vy>0){d.grounded=true;d.y=p.y-5;}}); if(d.y>420)d.grounded=true; } });
    }

    function draw() {
        if(!isGameRunning) return;
        const bIndex = getBiomeIndex(level); const t = BIOMES[bIndex];
        let grd = ctx.createLinearGradient(0,0,0,GH); grd.addColorStop(0, t.skyTop); grd.addColorStop(1, t.skyBot); ctx.fillStyle = grd; ctx.fillRect(0,0,GW,GH);
        ctx.save(); if(shake>0) ctx.translate((Math.random()-.5)*shake, (Math.random()-.5)*shake); ctx.translate(-Math.floor(cameraX), 0);

        bgElements.forEach(el => {
            let dx = (el.x - cameraX * (el.layer+1)*0.15) % (GW*2); if(dx<-200) dx+=GW*2;
            ctx.fillStyle = 'rgba(0,0,0,0.4)';
            if(bIndex===0) { ctx.beginPath(); ctx.moveTo(dx, GH); ctx.lineTo(dx+el.size, GH-el.size*2); ctx.lineTo(dx+el.size*2, GH); ctx.fill(); }
            else if(bIndex===1) { ctx.fillRect(dx, GH-el.size*3, el.size, el.size*3); }
            else { ctx.fillRect(dx, 0, el.size/2, GH); }
        });
        bgParticles.forEach(p=>{ctx.fillStyle=p.color; ctx.fillRect(p.x-cameraX, p.y, p.size, p.size)});

        platforms.forEach(p => { ctx.fillStyle=t.plat; ctx.fillRect(p.x, p.y, p.w, p.h); ctx.fillStyle=t.detail; ctx.fillRect(p.x, p.y, p.w, 10); });
        hazards.forEach(h => { if(h.active) { ctx.fillStyle='#111'; ctx.beginPath(); ctx.arc(h.x, h.y, 6, Math.PI, 0); ctx.fill(); ctx.fillStyle=(frameCount%20<10)?'#f00':'#500'; ctx.fillRect(h.x-2, h.y-8, 4, 4); } });
        bloodPools.forEach(pool => { ctx.fillStyle='#800000'; ctx.beginPath(); ctx.ellipse(pool.x, pool.y, pool.size, pool.size/4, 0, 0, Math.PI*2); ctx.fill(); });
        debris.forEach(d => { ctx.save(); ctx.translate(d.x, d.y); ctx.rotate(d.angle); ctx.fillStyle=(d.part==='head'?'#222':'#333'); ctx.fillRect(-d.w/2, -d.h/2, d.w, d.h); ctx.fillStyle='#b00'; ctx.fillRect(-d.w/2, -d.h/2, 4, 4); ctx.restore(); });

        if(goal) drawSprite(goal.x, goal.y+50, 'chopper', true, 'idle', frameCount);
        powerups.forEach(p => { if(p.active){ let dy=Math.sin(frameCount*0.1)*5; ctx.fillStyle=p.type==='L'?'#8e44ad':(p.type==='G'?'#2ecc71':'#e74c3c'); ctx.fillRect(p.x, p.y+dy, 24, 24); ctx.fillStyle='#fff'; ctx.fillText(p.type, p.x+8, p.y+dy+17); }});
        if(player) {
            enemies.forEach(e => { if(e.active) drawSprite(e.x+15, e.y+60, 'enemy', e.vx>0, 'run', frameCount+e.x); });
            if(player.invul%4<2) drawSprite(player.x+player.w/2, player.y+player.h, 'player', player.faceR, player.state, frameCount);
        }
        if(boss && boss.active) drawSprite(boss.x, boss.y+40, 'boss', false, 'idle', frameCount);
        bullets.forEach(b => { if(b.type==='rocket') { ctx.fillStyle='#fff'; ctx.fillRect(b.x-5, b.y-3, 12, 6); } else if(b.type==='grenade') { ctx.fillStyle='#2ecc71'; ctx.beginPath(); ctx.arc(b.x, b.y, 4, 0, Math.PI*2); ctx.fill(); } else { ctx.fillStyle=b.player?'#ff0':'#ff5500'; ctx.fillRect(b.x-5, b.y-2, 10, 4); } });
        particles.forEach(p => { if(p.type==='blood')ctx.fillStyle='#b00'; else if(p.type==='fire')ctx.fillStyle='#f39c12'; else ctx.fillStyle='#fff'; ctx.fillRect(p.x, p.y, p.size||4, p.size||4); });

        ctx.restore();
        document.getElementById('scoreDisplay').innerText = "SCORE: " + score.toString().padStart(6,'0');
        document.getElementById('stageDisplay').innerText = "OP " + level;
        document.getElementById('biomeDisplay').innerText = t.name;
    }

    function drawSprite(x,y,t,r,s,f) {
        ctx.save(); ctx.translate(Math.floor(x),Math.floor(y)); if(!r)ctx.scale(-1,1);
        
        if(t==='player'){ // HIGH FIDELITY PLAYER
            let lo = (s==='run')?Math.sin(f*0.4)*10:0; ctx.translate(0, -28 - ((s==='run')?Math.abs(Math.cos(f*0.4))*2:0));
            ctx.fillStyle='#2e332a'; ctx.beginPath(); ctx.moveTo(-2,10); ctx.lineTo(-4+lo,20); ctx.lineTo(-2+lo,28); ctx.lineTo(2,28); ctx.lineTo(3,10); ctx.fill(); ctx.fillStyle='#111'; ctx.fillRect(s==='jump'?-8:(-3+lo), 28, 6, 4);
            ctx.fillStyle='#4b5742'; ctx.beginPath(); ctx.moveTo(2,10); ctx.lineTo(4-lo,20); ctx.lineTo(6-lo,28); ctx.lineTo(1,28); ctx.lineTo(-2,10); ctx.fill(); ctx.fillStyle='#111'; ctx.fillRect(s==='jump'?4:(1-lo), 28, 6, 4);
            ctx.fillStyle='#dcb083'; ctx.fillRect(-6,-10,12,20); ctx.fillStyle='#111'; ctx.beginPath(); ctx.moveTo(-6,-10); ctx.lineTo(6,-10); ctx.lineTo(4,5); ctx.lineTo(-4,5); ctx.fill();
            ctx.fillStyle='#dcb083'; ctx.beginPath(); ctx.arc(0,-14,6,0,Math.PI*2); ctx.fill(); ctx.fillStyle='#e74c3c'; ctx.fillRect(-6,-18,12,4); ctx.beginPath(); ctx.moveTo(-6,-16); ctx.lineTo(-12,-14-Math.sin(f*0.2)*3); ctx.lineTo(-12,-18); ctx.fill();
            ctx.fillStyle='#dcb083'; ctx.fillRect(0,-8,12,4); ctx.fillRect(10,-6,4,4);
            ctx.fillStyle='#222'; ctx.fillRect(8,-8,22,5); ctx.fillStyle='#000'; ctx.fillRect(16,-3,5,5);
        } else if (t==='enemy') { // HIGH FIDELITY ENEMY (CLONED ANATOMY)
            let lo = Math.sin(f*0.4)*10; ctx.translate(0, -28 - Math.abs(Math.cos(f*0.4))*2);
            ctx.fillStyle='#2c3e50'; ctx.beginPath(); ctx.moveTo(-2,10); ctx.lineTo(-4+lo,20); ctx.lineTo(-2+lo,28); ctx.lineTo(2,28); ctx.lineTo(3,10); ctx.fill(); ctx.fillStyle='#000'; ctx.fillRect(-3+lo, 28, 6, 4);
            ctx.fillStyle='#34495e'; ctx.beginPath(); ctx.moveTo(2,10); ctx.lineTo(4-lo,20); ctx.lineTo(6-lo,28); ctx.lineTo(1,28); ctx.lineTo(-2,10); ctx.fill(); ctx.fillStyle='#000'; ctx.fillRect(1-lo, 28, 6, 4);
            ctx.fillStyle='#34495e'; ctx.fillRect(-6,-10,12,20); ctx.fillStyle='#111'; ctx.beginPath(); ctx.moveTo(-6,-10); ctx.lineTo(6,-10); ctx.lineTo(4,5); ctx.lineTo(-4,5); ctx.fill(); ctx.fillStyle='#555'; ctx.fillRect(-5,-6,4,6);
            ctx.fillStyle='#222'; ctx.beginPath(); ctx.arc(0,-14,7,0,Math.PI*2); ctx.fill(); ctx.fillStyle='#e74c3c'; ctx.fillRect(0,-16,6,4);
            ctx.fillStyle='#2c3e50'; ctx.fillRect(0,-8,12,4); ctx.fillStyle='#111'; ctx.fillRect(10,-6,4,4);
            ctx.fillStyle='#000'; ctx.fillRect(8,-8,22,5); ctx.fillStyle='#333'; ctx.fillRect(16,-3,5,5);
        } else if (t==='boss') {
            ctx.translate(0,-50); ctx.fillStyle='#111'; ctx.fillRect(-40,0,20,50); ctx.fillRect(20,0,20,50); ctx.fillStyle='#333'; ctx.fillRect(-50,-50,100,60); ctx.fillStyle='#f00'; ctx.fillRect(-20,-30,40,20);
        } else if (t==='chopper') {
            ctx.translate(0,-40); ctx.fillStyle='#000'; ctx.fillRect(-80,-25,160,4); ctx.fillStyle='#444'; ctx.beginPath(); ctx.ellipse(0,0,60,30,0,0,Math.PI*2); ctx.fill();
        }
        ctx.restore();
    }

    window.startGame = function() { initAudio(); document.getElementById('title-screen').style.display='none'; document.getElementById('ui-layer').style.display='flex'; level=1; score=0; lives=3; cameraX=0; player=new Player(); generateLevel(level); isGameRunning=true; let b=getBiomeIndex(level); startMusic(b); }
    window.resetGame = function() { document.getElementById('title-screen').style.display='flex'; document.getElementById('ui-layer').style.display='none'; isGameRunning=false; clearInterval(musicInterval); }
    window.nextLevel = function() { level++; if(level>20){alert("VICTORY");resetGame();return;} cameraX=0; player.x=100; player.y=100; player.hp=3; generateLevel(level); let b=getBiomeIndex(level); if(level%3===0)b='boss'; startMusic(b); }
    function loop() { if(isGameRunning){frameCount++; update();} if(isGameRunning)draw(); requestAnimationFrame(loop); }
    loop();
};
</script>
</body>
</html>
