<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>URBAN WARFARE: HANDHELD</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Press+Start+2P&display=swap');
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0;
            background-color: #111;
            height: 100vh; /* Fallback */
            height: 100dvh; /* Dynamic height handles mobile URL bars */
            width: 100vw;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Press Start 2P', cursive;
            touch-action: none; 
        }

        /* --- UI OVERLAY --- */
        #ui-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 9999; pointer-events: none;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }

        #fs-toggle {
            pointer-events: auto;
            position: fixed; top: 10px; right: 10px;
            background: rgba(0,0,0,0.5); border: 2px solid #fff; color: #fff;
            padding: 8px 12px; font-family: 'Press Start 2P'; font-size: 10px;
            z-index: 10000; cursor: pointer;
        }

        #boot-btn {
            pointer-events: auto;
            background: #e74c3c; border: 4px solid #fff;
            color: #fff; padding: 20px 40px; font-family: 'Black Ops One'; font-size: 20px;
            cursor: pointer; animation: pulse 1s infinite;
            text-transform: uppercase;
            box-shadow: 0 0 20px rgba(231, 76, 60, 0.6);
        }

        /* --- GBA CASE (Responsive "Contain" Logic) --- */
        #gba-case {
            background: #4a3b8f; 
            /* This ensures the aspect ratio stays locked, but it shrinks to fit screen */
            aspect-ratio: 16/9; 
            width: 95vw;
            max-height: 90vh; /* Leave room for UI bars */
            
            position: relative;
            display: flex; justify-content: center; align-items: center;
            
            border-radius: 20px;
            box-shadow: inset 0 5px 10px rgba(255,255,255,0.3), 0 0 50px rgba(0,0,0,0.8);
            border-bottom: 6px solid #322861;
            opacity: 0; transition: opacity 0.5s;
        }

        /* SCREEN BEZEL */
        #screen-bezel {
            background: #222;
            width: 65%; height: 85%;
            border-radius: 5px 5px 20px 20px;
            display: flex; justify-content: center; align-items: center;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.8);
            border-bottom: 4px solid #444;
            z-index: 10;
        }

        #game-wrapper {
            position: relative;
            width: 95%; height: 90%;
            background-color: #000;
            border: 2px solid #000;
        }

        canvas { width: 100%; height: 100%; display: block; image-rendering: pixelated; }

        #scanlines {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0) 60%, rgba(0,0,0,0.15) 60%);
            background-size: 100% 3px; pointer-events: none; z-index: 10; opacity: 0.6;
        }

        /* --- CONTROLS --- */
        #handheld-controls {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
        }

        /* D-PAD Area */
        .control-pad-area {
            position: absolute; top: 50%; transform: translateY(-50%);
            left: 2%; width: 18%; height: 50%; pointer-events: auto;
        }
        .d-pad { position: relative; width: 100%; height: 100%; }
        .d-btn { position: absolute; background: #333; border: 2px solid #111; box-shadow: inset 0 2px 2px rgba(255,255,255,0.2); }
        .d-btn:active { background: #555; }
        
        #btn-up { top: 10%; left: 35%; width: 30%; height: 30%; border-radius: 5px 5px 0 0; }
        #btn-down { bottom: 10%; left: 35%; width: 30%; height: 30%; border-radius: 0 0 5px 5px; }
        #btn-left { top: 35%; left: 10%; width: 30%; height: 30%; border-radius: 5px 0 0 5px; }
        #btn-right { top: 35%; right: 10%; width: 30%; height: 30%; border-radius: 0 5px 5px 0; }
        .d-center { position: absolute; top: 35%; left: 35%; width: 30%; height: 30%; background:#333; }

        /* BUTTONS Area */
        .action-btn-area {
            position: absolute; top: 50%; transform: translateY(-50%);
            right: 2%; width: 18%; height: 50%; pointer-events: auto;
        }
        .phys-btn {
            position: absolute;
            background: #7e6bbf; border: 2px solid #322861; border-radius: 50%;
            color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center;
            font-size: 10px; box-shadow: 2px 4px 0 #322861;
        }
        .phys-btn:active { transform: translate(1px, 2px); box-shadow: none; background: #9b8bd4; }

        #btn-shoot { top: 15%; right: 5%; width: 45%; height: 45%; background: #a69dd1; } /* A */
        #btn-jump { bottom: 15%; left: 5%; width: 45%; height: 45%; } /* B */
        
        #btn-grenade { 
            position: absolute; top: -10%; right: 15%;
            width: 70%; height: 25px; border-radius: 8px;
            background: #555; border-color: #222; color: #fff; font-size: 8px;
        }

        /* --- HUD --- */
        #ui-layer {
            position: absolute; top: 5px; left: 5px; width: calc(100% - 10px); pointer-events: none;
            display: none; justify-content: space-between; align-items: flex-start;
            font-size: 8px; z-index: 20; color: #fff; text-shadow: 1px 1px #000;
        }
        #hp-bar { display: flex; gap: 2px; margin-bottom: 2px; }
        .heart { width: 6px; height: 6px; background: #e74c3c; display: inline-block; border: 1px solid #fff; }

        #splash-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000;
            display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 200;
            animation: fadeOutSplash 4s forwards;
        }
        #splash-text { color: #fff; font-family: 'Black Ops One'; font-size: 14px; text-align: center; opacity: 0; animation: fadeInOutText 3s ease-in-out; }

        #title-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, #222, #000);
            display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 100; text-align: center;
        }
        h1 { font-family: 'Black Ops One'; color: #e74c3c; font-size: 24px; margin: 0; animation: pulse 3s infinite; }
        .start-msg { margin-top: 10px; font-size: 10px; color: #fff; animation: blink 1s infinite; }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes blink { 50% { opacity: 0; } }
        @keyframes fadeInOutText { 0%, 100% { opacity: 0; } 20%, 80% { opacity: 1; } }
        @keyframes fadeOutSplash { 90% { opacity: 1; pointer-events: all; } 100% { opacity: 0; pointer-events: none; } }
    </style>
</head>
<body>

<button id="fs-toggle" onclick="toggleFull()">[ ] FULLSCREEN</button>

<div id="ui-overlay">
    <div id="boot-msg" style="margin-bottom: 20px; font-size: 10px; color: #888; text-align:center;">ROTATE PHONE FOR BEST EXPERIENCE</div>
    <button id="boot-btn" onclick="bootSystem()">BOOT SYSTEM</button>
</div>

<div id="gba-case">
    <div id="handheld-controls">
        <div class="control-pad-area">
            <div class="d-pad">
                <div class="d-center"></div>
                <div class="d-btn" id="btn-up"></div>
                <div class="d-btn" id="btn-down"></div>
                <div class="d-btn" id="btn-left"></div>
                <div class="d-btn" id="btn-right"></div>
            </div>
        </div>
        <div class="action-btn-area">
            <div class="phys-btn" id="btn-grenade">G</div>
            <div class="phys-btn" id="btn-shoot">A</div>
            <div class="phys-btn" id="btn-jump">B</div>
        </div>
    </div>

    <div id="screen-bezel">
        <div id="game-wrapper">
            <canvas id="gameCanvas" width="480" height="270"></canvas>
            <div id="scanlines"></div>
            <div id="ui-layer">
                <div>
                    <div id="hp-bar"></div>
                    <div id="livesDisplay" style="color:#aaa;">x3</div>
                    <div id="grenadeDisplay" style="color:#2ecc71;">G:3</div>
                </div>
                <div style="text-align:right;">
                    <span id="scoreDisplay">000000</span><br>
                    <span id="stageDisplay" style="color:#f1c40f;">OP 1</span>
                </div>
            </div>
            <div id="splash-screen"><div id="splash-text">SUNDOWN INTERACTIVE<br><span style="color:#e74c3c;">2026</span></div></div>
            <div id="title-screen"><h1>URBAN WARFARE</h1><div class="start-msg">PRESS START</div></div>
        </div>
    </div>
</div>

<script>
    function toggleFull() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(e => { console.log(e); });
        } else {
            if (document.exitFullscreen) document.exitFullscreen();
        }
    }

    function bootSystem() {
        // Attempt fullscreen on boot
        toggleFull();
        document.getElementById('ui-overlay').style.display = 'none';
        document.getElementById('fs-toggle').style.display = 'none'; // Hide toggle once game starts to clean UI
        document.getElementById('gba-case').style.opacity = '1';
        initGame();
    }

    /* --- GAME ENGINE --- */
    function initGame() {
        const title = document.getElementById('title-screen');
        setTimeout(() => { title.style.display = 'flex'; void title.offsetWidth; title.style.opacity = '1'; }, 3500);

        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let actx, noiseBuffer, musicInterval = null, musicEnabled = true, currentNote = 0;
        const MUSIC_TRACKS = { 0: [110, 110, 0, 123, 110, 0, 130, 0], 1: [82, 0, 82, 82, 98, 0, 82, 123], boss: [110, 123, 130, 146, 110, 123, 130, 164] };

        function initAudio() { 
            try { if (!actx) { actx = new AudioContext(); const b = actx.sampleRate; noiseBuffer = actx.createBuffer(1, b, actx.sampleRate); const o = noiseBuffer.getChannelData(0); for (let i = 0; i < b; i++) o[i] = Math.random() * 2 - 1; } if (actx.state === 'suspended') actx.resume(); } catch(e){}
        }

        function playGunShot() {
            if(!actx || !musicEnabled) return;
            const t = actx.currentTime;
            const osc = actx.createOscillator(); osc.type = 'square'; osc.frequency.setValueAtTime(120, t); osc.frequency.exponentialRampToValueAtTime(40, t + 0.1);
            const g = actx.createGain(); g.gain.setValueAtTime(0.2, t); g.gain.exponentialRampToValueAtTime(0.01, t + 0.1);
            osc.connect(g); g.connect(actx.destination); osc.start(t); osc.stop(t + 0.15);
            const src = actx.createBufferSource(); src.buffer = noiseBuffer;
            const f = actx.createBiquadFilter(); f.type='lowpass'; f.frequency.value=1000;
            const g2 = actx.createGain(); g2.gain.setValueAtTime(0.4, t); g2.gain.exponentialRampToValueAtTime(0.01, t + 0.15);
            src.connect(f); f.connect(g2); g2.connect(actx.destination); src.start(t); src.stop(t + 0.2);
        }
        function startMusic(idx) {
            if(musicInterval) clearInterval(musicInterval); if(!musicEnabled) return;
            let track = MUSIC_TRACKS[idx] || MUSIC_TRACKS[0]; currentNote = 0;
            musicInterval = setInterval(() => {
                if(!isGameRunning) return;
                let freq = track[currentNote % track.length];
                if(freq > 0) playSynth(freq, 'sawtooth', 0.1, 0.05);
                currentNote++;
            }, 150);
        }
        function playSynth(f,t,d,v){if(!actx)return;const o=actx.createOscillator();const g=actx.createGain();o.type=t;o.frequency.value=f;g.gain.setValueAtTime(v,actx.currentTime);g.gain.exponentialRampToValueAtTime(0.001,actx.currentTime+d);o.connect(g);g.connect(actx.destination);o.start();o.stop(actx.currentTime+d);}
        function playNoise(d,f,v){if(!actx)return;const s=actx.createBufferSource();s.buffer=noiseBuffer;const fl=actx.createBiquadFilter();fl.frequency.value=f;const g=actx.createGain();g.gain.setValueAtTime(v,actx.currentTime);g.gain.exponentialRampToValueAtTime(0.01,actx.currentTime+d);s.connect(fl);fl.connect(g);g.connect(actx.destination);s.start();s.stop(actx.currentTime+d);}

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        ctx.imageSmoothingEnabled = false;
        const GW=480; const GH=270; 
        let isGameRunning=false; let level=1; let score=0; let lives=3; let frameCount=0; let cameraX=0; let shake=0;
        const keys={ArrowLeft:false,ArrowRight:false,ArrowUp:false,ArrowDown:false,z:false,x:false,c:false};
        let cPressed=false;

        window.addEventListener('keydown', e => { if(keys.hasOwnProperty(e.key)) keys[e.key]=true; if(e.key==="Enter"&&!isGameRunning&&title.style.display==='flex') startGame(); });
        window.addEventListener('keyup', e => { if(keys.hasOwnProperty(e.key)) keys[e.key]=false; if(e.key==='c') cPressed=false; });

        function bindTouch(id, key) {
            const el = document.getElementById(id);
            el.addEventListener('touchstart', (e) => { e.preventDefault(); keys[key] = true; if(!isGameRunning && title.style.display==='flex' && (key==='z'||key==='x')) startGame();}, {passive:false});
            el.addEventListener('touchend', (e) => { e.preventDefault(); keys[key] = false; if(key==='c') cPressed=false; }, {passive:false});
        }
        bindTouch('btn-left', 'ArrowLeft'); bindTouch('btn-right', 'ArrowRight'); bindTouch('btn-up', 'ArrowUp'); bindTouch('btn-down', 'ArrowDown');
        bindTouch('btn-jump', 'z'); bindTouch('btn-shoot', 'x'); bindTouch('btn-grenade', 'c');
        
        let player=null, platforms=[], enemies=[], bullets=[], particles=[], debris=[];
        const BIOMES = [{c1:'#87CEEB',c2:'#228B22'},{c1:'#2c3e50',c2:'#e74c3c'}];

        class Player {
            constructor() { this.x=50; this.y=100; this.w=10; this.h=24; this.vx=0; this.vy=0; this.grounded=false; this.faceR=true; this.hp=3; this.grenades=3; this.invul=0; }
            update() {
                if(keys.ArrowRight){this.vx=3; this.faceR=true;} else if(keys.ArrowLeft){this.vx=-3; this.faceR=false;} else{this.vx*=0.8;}
                if(keys.z && this.grounded){this.vy=-9; this.grounded=false; playSynth(150,'triangle',0.1,0.1);}
                if(keys.x && frameCount%15===0) this.shoot();
                if(keys.c && !cPressed && this.grenades>0) { cPressed=true; this.grenades--; bullets.push({x:this.x,y:this.y,vx:this.faceR?5:-5,vy:-6,type:'grenade',active:true}); }
                this.vy+=0.5; this.x+=this.vx; this.y+=this.vy; this.grounded=false;
                platforms.forEach(p=>{if(this.x<p.x+p.w && this.x+this.w>p.x && this.y+this.h>p.y && this.y+this.h<p.y+p.h+15 && this.vy>=0){this.y=p.y-this.h; this.vy=0; this.grounded=true;}});
                if(this.y>GH+50) takeDamage(3);
                if(this.x<cameraX) this.x=cameraX;
                cameraX += (this.x - GW*0.4 - cameraX) * 0.1;
                if(this.invul>0) this.invul--;
            }
            shoot() {
                shake=3; playGunShot();
                bullets.push({x:this.x+(this.faceR?15:-5), y:this.y+10, vx:this.faceR?10:-10, vy:0, player:true, active:true, type:'normal'});
                debris.push({x:this.x,y:this.y+10,vx:this.faceR?-2:2,vy:-3,life:20,type:'shell'});
            }
        }

        function generateLevel(l) {
            platforms=[]; enemies=[]; bullets=[]; particles=[]; debris=[];
            let cx=0; platforms.push({x:0,y:GH-40,w:800,h:40}); cx+=800;
            for(let i=0; i<10+l; i++) {
                let gap=50, w=200+Math.random()*200, h=GH-40 - (Math.random()*100);
                platforms.push({x:cx+gap, y:h, w:w, h:200});
                if(Math.random()>0.5) enemies.push({x:cx+gap+50, y:h-40, hp:3, active:true, vx:1, min:cx+gap, max:cx+gap+w});
                cx+=gap+w;
            }
            platforms.push({x:cx+50, y:GH-40, w:300, h:40}); player.goal={x:cx+150};
        }

        function takeDamage(n) { if(player.invul>0)return; player.hp-=n; player.invul=60; shake=15; playNoise(0.2,100,0.5); if(player.hp<=0){lives--; if(lives>0) resetGame(); else {alert("GAME OVER"); location.reload();}} }
        function resetGame() { player.x=cameraX+50; player.y=0; player.hp=3; player.vy=0; }
        
        function update() {
            if(!isGameRunning) return; if(shake>0) shake--;
            player.update();
            if(player.x > player.goal.x) { level++; generateLevel(level); player.x=cameraX+50; }
            enemies.forEach(e=>{
                if(!e.active)return; e.x+=e.vx; if(e.x<e.min||e.x>e.max)e.vx*=-1;
                if(Math.abs(player.x-e.x)<10 && Math.abs(player.y-e.y)<20) takeDamage(1);
            });
            bullets.forEach(b=>{
                if(!b.active)return; b.x+=b.vx; b.y+=b.vy; if(b.type==='grenade') b.vy+=0.3;
                if(b.type==='grenade' && b.y>GH-40) { b.active=false; shake=10; playNoise(0.3,100,0.6); enemies.forEach(e=>{if(Math.abs(e.x-b.x)<60) e.active=false;}); }
                if(b.player) enemies.forEach(e=>{ if(e.active && Math.abs(b.x-e.x)<15 && Math.abs(b.y-e.y)<25) { e.hp--; b.active=false; if(e.hp<=0){e.active=false; score+=100;}} });
            });
            debris.forEach(d=>{d.x+=d.vx; d.y+=d.vy; d.vy+=0.5; d.life--;}); debris=debris.filter(d=>d.life>0);
            
            document.getElementById('livesDisplay').innerText='x'+lives;
            document.getElementById('grenadeDisplay').innerText='G:'+player.grenades;
            document.getElementById('scoreDisplay').innerText=score;
            document.getElementById('stageDisplay').innerText='OP '+level;
            let h=''; for(let i=0;i<player.hp;i++) h+='<div class="heart"></div>'; document.getElementById('hp-bar').innerHTML=h;
        }

        function draw() {
            if(!isGameRunning) return;
            const b = BIOMES[level%2];
            const grd = ctx.createLinearGradient(0,0,0,GH); grd.addColorStop(0,b.c1); grd.addColorStop(1,b.c2); ctx.fillStyle=grd; ctx.fillRect(0,0,GW,GH);
            ctx.save(); if(shake>0) ctx.translate(Math.random()*shake-shake/2, Math.random()*shake-shake/2); ctx.translate(-cameraX,0);
            
            platforms.forEach(p=>{ctx.fillStyle='#222'; ctx.fillRect(p.x,p.y,p.w,p.h); ctx.fillStyle='#000'; ctx.fillRect(p.x,p.y,p.w,5);});
            if(player.invul%4<2) { ctx.fillStyle='#8e44ad'; ctx.fillRect(player.x,player.y,player.w,player.h); }
            enemies.forEach(e=>{if(e.active){ctx.fillStyle='#c0392b'; ctx.fillRect(e.x,e.y,12,24);}});
            bullets.forEach(b=>{ctx.fillStyle=b.type==='grenade'?'#2ecc71':'#f1c40f'; ctx.fillRect(b.x-2,b.y-2,4,4);});
            debris.forEach(d=>{ctx.fillStyle='#f1c40f'; ctx.fillRect(d.x,d.y,2,2);});
            ctx.restore();
        }

        window.startGame = function() { initAudio(); document.getElementById('title-screen').style.display='none'; document.getElementById('ui-layer').style.display='flex'; isGameRunning=true; player=new Player(); generateLevel(1); startMusic(0); loop(); }
        function loop() { if(isGameRunning){frameCount++; update();} if(isGameRunning)draw(); requestAnimationFrame(loop); }
    }
</script>
</body>
</html>
